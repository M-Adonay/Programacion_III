<div class="card bg-secondary" id="cardLibros">
    <div class="card-header">
        <h1>Libros</h1>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert" data-bs-target="#cardLibros" aria-label="Close"></button>
    </div>
    <form enctype="multipart/form-data" class="d-grid gap-3 ml-4 p-2" id="frmLibros" data-accion="insertar" data-id="0">
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="txtTituloLibro">Titulo</label>
                    <input type="text" class="form-control" id="txtTituloLibro" name="txtTituloLibro" placeholder="Titulo">
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="txtAutorLibro">Autor</label>
                    <input type="text" class="form-control" id="txtAutorLibro" name="txtAutorLibro" placeholder="Autor">
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="txtEdicionLibro">Fecha de Edicion</label>
                    <input type="date" class="form-control" id="txtEdicionLibro" name="txtEdicionLibro" placeholder="Edicion">
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="sltGeneroLibro">Genero</label>
                    <select class="form-control" id="sltGeneroLibro" name="sltGeneroLibro[]" multiple>
                    </select>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="form-group">
                    <label for="txtSinopsisLibro">Sinopsis</label>
                    <textarea class="form-control" id="txtSinopsisLibro" name="txtSinopsisLibro" rows="3"></textarea>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="imgLibro">Portada</label>
                    <input type="file" class="form-control-file" id="imgLibro" name="imgLibro" required>
                    <canvas id="canvasLibro" hidden></canvas>
                    <div class="col-md-6">
                        <div for="imgLibro" style="background-image: url(https://i.pinimg.com/736x/7e/23/8d/7e238d1b3dfe91ba8741d3215b7a6165.jpg); width: 300px; height: 450px; background-position: center center; background-size: 200%; padding: 0;">
                            <img id="imgLibroPreview" class="" src="" alt="" width="" height="">
                        </div>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="chkActualizarImagenLibro" name="chkActualizarImagenLibro" disabled>
                        <label class="form-check-label" for="chkActualizarImagenLibro">Actualizar Imagen</label>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label for="txtCantidadLibro">Cantidad</label>
                            <input type="number" class="form-control" id="txtCantidadLibro" name="txtCantidadLibro" placeholder="Cantidad">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <button type="submit" class="btn btn-primary mt-2" id="btnInsertarLibro">Agregar</button>
                <button type="reset" class="btn btn-primary mt-2" id="btnLimpiarLibro">Limpiar</button>
                <button type="button" class="btn btn-success mt-2" id="btnBuscarLibros">Buscar</button>
            </div>
        </div>
    </form>
    
    <div class="alert alert-success alert-dismissible fade show d-none m-2" id="alertaLibros" role="alert">
    </div>
</div>
<script>
    function mostrarGeneros() {
        $.get('http://localhost:3000/mostrar_generos', (generos) => {
            console.log(generos);
            $('#sltGeneroLibro').html('');
            generos.resultado.forEach(genero => {
                $('#sltGeneroLibro').append(`<option value="${genero.idGenero}">${genero.Nombre}</option>`);
            });
        }, 'json');
    }
    function actualizarLibro(libro) {
        $('#frmLibros').data('accion', 'actualizar');
        $('#frmLibros').data('id', libro.idLibro);
        $('#txtTituloLibro').val(libro.Titulo);
        $('#txtAutorLibro').val(libro.Autor);
        $('#txtEdicionLibro').val(libro.Edicion);
        $('#txtSinopsisLibro').val(libro.Sinopsis);
        if (libro.idGeneros != null) {
            let generos = libro.idGeneros.split(',');
            $('#sltGeneroLibro').val(generos);
        } else {
            $('#sltGeneroLibro').val([]);
        }
        $('#imgLibro').val('');
        $('#txtCantidadLibro').val(libro.Cantidad);
        $('#imgLibro').prop('required', false);
        $('#imgLibroPreview').attr('src', libro.Imagen);
        $('#chkActualizarImagenLibro').prop('disabled', false).prop('checked', false);
    }
    function limpiarLibros() {
        $('#frmLibros').data('accion', 'insertar');
        $('#frmLibros').data('id', 0);
        $('#txtTituloLibro').val('');
        $('#txtAutorLibro').val('');
        $('#txtEdicionLibro').val('');
        $('#txtSinopsisLibro').val('');
        $('#sltGeneroLibro').val('');
        $('#imgLibro').val('');
        $('#txtCantidadLibro').val('');
        $('#imgLibro').prop('required', true);
        $('#imgLibroPreview').attr('src', '').attr('width', '0').attr('height', '0');
        $('#chkActualizarImagenLibro').prop('disabled', true).prop('checked', false);
    }
    $(document).ready(e => {
        mostrarGeneros();

        $('#chkActualizarImagenLibro').change(e => {
            if ($('#chkActualizarImagenLibro').is(':checked')) {
                $('#imgLibro').prop('required', true);
            } else {
                $('#imgLibro').prop('required', false);
            }
        });

        $('#imgLibro').change(e => {
            $('#btnInsertarLibro').prop('disabled', true);
            let img = new Image();
            let file = e.target.files[0];
            let reader = new FileReader();
            reader.onload = function(e) {
                img.src = e.target.result;
                $('#imgLibroPreview').attr('src', e.target.result).width(300).height(450);
                img.onload = function() {
                    let canvas = document.getElementById('canvasLibro');
                    let ctx = canvas.getContext('2d');
                    canvas.width = 300;
                    canvas.height = 450;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    $('#btnInsertarLibro').prop('disabled', false);
                }
            }
            reader.readAsDataURL(file);
        });
        $('#frmLibros').submit(e => {
            e.preventDefault();
            let canvas = document.getElementById('canvasLibro');
            let ctx = canvas.getContext('2d');
            console.log(canvas, canvas.width, canvas.height);
            let imagen = [];
            for(i=0; i<canvas.height; i++){
                for(j=0; j< canvas.width; j++){
                    let imgdata = ctx.getImageData(j,i,1,1).data,
                        pixel = imgdata[0] + ',' + imgdata[1] + ',' + imgdata[2];
                    imagen.push(pixel);
                }
            }
            imagen = imagen.join(',');
            let accion = $('#frmLibros').data('accion'),
                id = $('#frmLibros').data('id'),
                titulo = $('#txtTituloLibro').val(),
                autor = $('#txtAutorLibro').val(),
                edicion = $('#txtEdicionLibro').val(),
                sinopsis = $('#txtSinopsisLibro').val(),
                genero = $('#sltGeneroLibro').val(),
                cantidad = $('#txtCantidadLibro').val(),
                nuevaimagen = $('#chkActualizarImagenLibro').is(':checked'),
                alto = canvas.height,
                ancho = canvas.width,
                datos = {
                    accion: accion,
                    id: id,
                    titulo: titulo,
                    autor: autor,
                    edicion: edicion,
                    sinopsis: sinopsis,
                    generos: genero,
                    cantidad: cantidad,
                    imagen: imagen,
                    nuevaimagen: nuevaimagen,
                    alto: alto,
                    ancho: ancho
                };
            console.log(datos);
            $.post('http://localhost:3000/administrar_libro', JSON.stringify(datos), (libro) => {
                console.log(libro);
                
                if (libro.respuesta[0] == true) {
                    html = `<strong>Usuario agregado correctamente</strong>
                        <button type="button" class="close" data-bs-dismiss="alert" aria-label="Close">
                            X
                        </button>`;
                    $('#alertaLibros').html(html);
                    $('#alertaLibros').removeClass('d-none');
                    $('#alertaLibros').removeClass('alert-danger')
                        .addClass('alert-success');
                    setTimeout(() => {
                        $('#alertaLibros').addClass('d-none');
                    }, 5000);
                    limpiarLibros();
                    mostrarLibros();
                } else {
                    html = `<strong>Error al agregar el usuario</strong>
                        <button type="button" class="close" data-bs-dismiss="alert" aria-label="Close">
                            X
                        </button>`;
                    $('#alertaLibros').html(html);
                    $('#alertaLibros').removeClass('d-none');
                    $('#alertaLibros').removeClass('alert-success')
                        .addClass('alert-danger');
                    setTimeout(() => {
                        $('#alertaLibros').addClass('d-none');
                    }, 5000);
                }
            }, 'json');
        })
        .on('reset', e => {
                limpiarLibros();
        });

        $('#btnBuscarLibros').click(e => {
            e.preventDefault();
            abrir_ventana("libros", "buscar");
        });

    });
</script>